<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 320px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 6px; padding: 6px; border-bottom: 1px solid #eee; }
        .controls { margin-bottom: 12px; padding: 10px; background: #f0f0f0; border-radius: 6px; }
        input { padding: 6px; margin-right: 6px; }
        button { padding: 6px 12px; }
    </style>
</head>
<body>
<h2>Chat Test</h2>

<div class="controls">
    <input type="text" id="login" placeholder="Login">
    <input type="text" id="token" placeholder="JWT Token">
    <button onclick="connect()">Connect</button>
    <span id="status" style="margin-left: 10px; color: red; font-weight: bold;">Disconnected</span>
</div>

<div id="messages"></div>

<div class="controls">
    <input type="text" id="msg" placeholder="Type message..." style="width: 300px;" disabled>
    <button id="sendBtn" onclick="send()" disabled>Send</button>
</div>

<script>
    let socket;
    const origin = window.location.origin === "null" ? "http://localhost:8080" : window.location.origin;

    function connect() {
        const login = document.getElementById("login").value;
        if (!login) return alert("Login is required");

        const wsUrl = origin.replace(/^http/, "ws") + "/ws?email=" + encodeURIComponent(login);
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            document.getElementById("status").innerText = "Connected: " + login;
            document.getElementById("status").style.color = "green";
            document.getElementById("msg").disabled = false;
            document.getElementById("sendBtn").disabled = false;
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const container = document.getElementById("messages");
            const div = document.createElement("div");
            div.className = "message";
            div.id = "msg-" + data.id;
            div.innerHTML = `
                <strong>${data.sender}:</strong> ${data.content}
                <button onclick="deleteMessage('${data.id}')">Delete</button>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        };

        socket.onclose = () => {
            document.getElementById("status").innerText = "Disconnected";
            document.getElementById("status").style.color = "red";
            document.getElementById("msg").disabled = true;
            document.getElementById("sendBtn").disabled = true;
        };
    }

    function send() {
        const input = document.getElementById("msg");
        if (!socket || socket.readyState !== WebSocket.OPEN) return;
        if (!input.value.trim()) return;
        socket.send(input.value);
        input.value = "";
    }

    function deleteMessage(id) {
        const token = document.getElementById("token").value;
        if (!token) return alert("Token is required");
        fetch(`${origin}/api/chat/messages/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        }).then(res => {
            if (res.ok) {
                const el = document.getElementById("msg-" + id);
                if (el) el.remove();
            } else {
                res.text().then(text => alert(text));
            }
        }).catch(err => console.error(err));
    }
</script>
</body>
</html>