<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee; }
        .delete-btn { color: red; cursor: pointer; border: none; background: none; font-weight: bold; margin-left: 10px; }
        .delete-btn:hover { background-color: #ffeaea; border-radius: 3px; }
        .controls { margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        input { padding: 5px; margin-right: 5px; }
    </style>
</head>
<body>
<h2>Chat Test</h2>

<div class="controls">
    <input type="text" id="email" placeholder="Email">
    <input type="text" id="token" placeholder="JWT Token">
    <button onclick="connect()">Connect</button>
</div>

<div id="status" style="color:red; font-weight:bold;">Disconnected</div>

<div id="messages"></div>

<div class="controls">
    <input type="text" id="msg" placeholder="Message..." style="width: 300px;" disabled>
    <button id="sendBtn" onclick="send()" disabled>Send</button>
</div>

<script>
    let socket;

    function connect() {
        const email = document.getElementById("email").value;
        if (!email) return alert("Email is required");

        socket = new WebSocket("ws://localhost:8080/ws?email=" + email);

        socket.onopen = () => {
            document.getElementById("status").innerText = "Connected: " + email;
            document.getElementById("status").style.color = "green";
            document.getElementById("msg").disabled = false;
            document.getElementById("sendBtn").disabled = false;
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "delete_message") {
                const el = document.getElementById("msg-" + data.id);
                if (el) {
                    el.remove();
                }
                return;
            }

            const container = document.getElementById("messages");
            const div = document.createElement("div");
            div.className = "message";
            div.id = "msg-" + data.id;

            div.innerHTML = `
                    <strong>${data.sender}:</strong> ${data.content}
                    <button class="delete-btn" onclick="deleteMessage('${data.id}')">âœ–</button>
                `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        };

        socket.onclose = () => {
            document.getElementById("status").innerText = "Disconnected";
            document.getElementById("status").style.color = "red";
        };
    }

    function send() {
        const input = document.getElementById("msg");
        if (!socket || socket.readyState !== WebSocket.OPEN) return;
        socket.send(input.value);
        input.value = "";
    }

    function deleteMessage(id) {
        const token = document.getElementById("token").value;
        if (!token) return alert("Token is required");

        if (!confirm("Delete message?")) return;

        fetch(`/api/chat/messages/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => {
                if (!res.ok) {
                    res.text().then(text => alert("Error: " + text));
                }
            })
            .catch(err => console.error(err));
    }
</script>
</body>
</html>